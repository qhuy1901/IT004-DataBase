CREATE DATABASE DE10_QuanLyCuaHangCayCanh
USE DE10_QuanLyCuaHangCayCanh

CREATE TABLE KHACHHANG
(
	MAKH CHAR(4) CONSTRAINT KH_MAKH_PK PRIMARY KEY,
	TENKH VARCHAR(30) NOT NULL,
	DIACHI VARCHAR(25),
	LOAIKH VARCHAR(25)
)

CREATE TABLE LOAICAY
(
	MALC CHAR(4) CONSTRAINT LC_MALC_PK PRIMARY KEY,
	TENLC VARCHAR(30) NOT NULL,
	XUATXU VARCHAR(25),
	GIA MONEY
)

CREATE TABLE HOADON
(
	SOHD CHAR(5) CONSTRAINT HD_SOHD_PK PRIMARY KEY,
	NGHD SMALLDATETIME,
	MAKH CHAR(4) CONSTRAINT HD_MAKH_FK FOREIGN KEY
			REFERENCES KHACHHANG(MAKH),
	KHUYENMAI INT
)

CREATE TABLE CTHD
(
	SOHD CHAR(5) CONSTRAINT CTHD_SOHD_FK FOREIGN KEY
			REFERENCES HOADON(SOHD),
	MALC CHAR(4) CONSTRAINT CTHD_MALC_FK FOREIGN KEY
			REFERENCES LOAICAY(MALC),
	CONSTRAINT CTHD_SOHD_MALC_PK PRIMARY KEY(SOHD,MALC),
	SOLUONG INT
)

SET DATEFORMAT DMY

INSERT INTO KHACHHANG VALUES('KH01','Liz Kim Cuong','Ha Noi','Vang lai')
INSERT INTO KHACHHANG VALUES('KH02','Ivone Dieu Linh','Da Nang','Thuong xuyen')
INSERT INTO KHACHHANG VALUES('KH03','Emma Nhat Khanh','TP.HCM ','Vang lai')

INSERT INTO LOAICAY VALUES('LC01','Xuong rong tai tho','Mexico',180000)
INSERT INTO LOAICAY VALUES('LC02','Sen thach ngoc','Anh',300000)
INSERT INTO LOAICAY VALUES('LC03','Ba mau rau','Nam Phi',270000)

INSERT INTO HOADON VALUES('00001','22/11/2017','KH01',5)
INSERT INTO HOADON VALUES('00002','04/12/2017','KH03',5)
INSERT INTO HOADON VALUES('00003','10/12/2017','KH02',10)

INSERT INTO CTHD VALUES('00001','LC01',1)
INSERT INTO CTHD VALUES('00002','LC01',1)
INSERT INTO CTHD VALUES('00003','LC01',1)
INSERT INTO CTHD VALUES('00001','LC02',2)
INSERT INTO CTHD VALUES('00001','LC03',2)
INSERT INTO CTHD VALUES('00003','LC03',5)

/*3. Hiện thực ràng buộc toàn vẹn sau: Tất cả các mặt hàng xuất xứ từ nước Anh đều có giá lớn
hơn 250.000*/
GO
CREATE TRIGGER TRG_LOAICAY_XUATXU_INS_UDP ON LOAICAY
FOR UPDATE, INSERT
AS
BEGIN
	DECLARE @XUATXU VARCHAR(25),
			@GIA MONEY

	SELECT @XUATXU = XUATXU, @GIA = GIA
	FROM INSERTED

	IF(@XUATXU = 'Anh' AND @GIA < 250000)
	BEGIN
		PRINT('LOI: Tat ca mat hang xuat xu tu nuoc Anh deu co gia lon hon 250000')
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
UPDATE LOAICAY
SET GIA = 150000
WHERE MALC = 'LC02'

/*4. Hiện thực ràng buộc toàn vẹn sau: Hóa đơn mua với số lượng tổng cộng lớn hơn hoặc bằng
5 đều được giảm giá 10 phần trăm.*/
GO
CREATE TRIGGER TRG_CTHD_SOLUONG_INS_UPD ON CTHD
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @SOHD INT,
			@TongSL INT

	SELECT @SOHD = SOHD
	FROM INSERTED

	SELECT @TongSL = SUM(SOLUONG)
	FROM CTHD
	WHERE SOHD = @SOHD

	IF(@TongSL >= 5)
	BEGIN
		UPDATE HOADON
		SET KHUYENMAI = 10
		WHERE SOHD = @SOHD
	END
END
--Kiểm tra Trigger
SELECT* FROM CTHD
SELECT* FROM HOADON
UPDATE CTHD
SET SOLUONG = 10
WHERE SOHD = '00001'AND MALC = 'LC01' 

GO
CREATE TRIGGER TRG_HOADON_KHUYENMAI_UPD ON HOADON
FOR UPDATE
AS
BEGIN
	DECLARE @SOHD INT, 
			@KHUYENMAI INT,
			@TongSL INT

	SELECT @SOHD = SOHD, @KHUYENMAI = KHUYENMAI
	FROM INSERTED

	SELECT @TongSL = SUM(SOLUONG)
	FROM CTHD
	WHERE SOHD = @SOHD

	IF(@TongSL >= 5 AND @KHUYENMAI <> 10)
	BEGIN
		PRINT('LOI: Hoa don mua voi so luong tong cong lon hon hoac bang 5 deu duoc giam gia 10 phan tram')
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
UPDATE HOADON
SET KHUYENMAI = 11
WHERE SOHD = '00001'

/*5. Tìm tất cả các hóa đơn có ngày lập hóa đơn trong quý 4 năm 2017, sắp xếp kết quả tăng dần
theo phần trăm giảm giá.*/
SELECT SOHD
FROM HOADON
WHERE (MONTH(NGHD) BETWEEN 10 AND 12)
AND YEAR(NGHD) = 2017
ORDER BY KHUYENMAI ASC

/*6. Tìm loại cây có số lượng mua ít nhất trong tháng 12.*/
SELECT LC.MALC, TENLC 
FROM (LOAICAY LC JOIN CTHD ON LC.MALC = CTHD.MALC)
			JOIN HOADON HD ON HD.SOHD = CTHD.SOHD
WHERE MONTH(NGHD) = 12
GROUP BY LC.MALC, TENLC 
HAVING SUM(SOLUONG) <= ALL(	SELECT SUM(SOLUONG)
							FROM (LOAICAY LC JOIN CTHD ON LC.MALC = CTHD.MALC)
										JOIN HOADON HD ON HD.SOHD = CTHD.SOHD
							WHERE MONTH(NGHD) = 12
							GROUP BY LC.MALC, TENLC)

/*7. Tìm loại cây mà cả khách thường xuyên (LOAIKH là ‘Thuong xuyen’) và khách vãng lai
(LOAIKH là ‘Vang lai’) đều mua.*/
SELECT LC.MALC, TENLC 
FROM ((LOAICAY LC JOIN CTHD ON LC.MALC = CTHD.MALC)
			JOIN HOADON HD ON HD.SOHD = CTHD.SOHD)
					JOIN KHACHHANG KH ON KH.MAKH = HD.MAKH
WHERE LOAIKH = 'Thuong xuyen'
INTERSECT
SELECT LC.MALC, TENLC 
FROM ((LOAICAY LC JOIN CTHD ON LC.MALC = CTHD.MALC)
			JOIN HOADON HD ON HD.SOHD = CTHD.SOHD)
					JOIN KHACHHANG KH ON KH.MAKH = HD.MAKH
WHERE LOAIKH = 'Vang lai'

/*8. Tìm khách hàng đã từng mua tất cả các loại cây*/
SELECT MAKH, TENKH
FROM KHACHHANG KH
WHERE NOT EXISTS(	SELECT*
					FROM LOAICAY LC
					WHERE NOT EXISTS(	SELECT*
										FROM HOADON HD JOIN CTHD ON CTHD.SOHD = HD.SOHD
										WHERE HD.MAKH = KH.MAKH
										AND LC.MALC = CTHD.MALC))
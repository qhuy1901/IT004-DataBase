CREATE DATABASE DE5_QuanLyThanhVienVaBaiTap
USE DE5_QuanLyThanhVienVaBaiTap

CREATE TABLE BAITAP
(
	MABT CHAR(3) CONSTRAINT BT_MABT_PK PRIMARY KEY,
	MADK INT,
	TENBT VARCHAR(25)
)

CREATE TABLE DOKHO
(
	MADK INT CONSTRAINT DK_MADK_PK PRIMARY KEY,
	DIEMDK INT
)

CREATE TABLE NOPBAI
(
	MABN CHAR(3) CONSTRAINT NB_MANB_PK PRIMARY KEY,
	MATV CHAR(3),
	MABT CHAR(3),
	NGAYNOP SMALLDATETIME,
	DIEMHT INT
)

CREATE TABLE THANHVIEN
(
	MATV CHAR(3) CONSTRAINT TV_MATV_PK PRIMARY KEY,
	TENTV VARCHAR(25),
	THUHANG INT,
	LOAITV VARCHAR(15),
	NGDK SMALLDATETIME
)

ALTER TABLE BAITAP ADD CONSTRAINT BT_MADK_FK FOREIGN KEY(MADK)
	REFERENCES DOKHO(MADK)

ALTER TABLE NOPBAI ADD CONSTRAINT NB_MATV_FK FOREIGN KEY(MATV)
	REFERENCES THANHVIEN(MATV)

ALTER TABLE NOPBAI ADD CONSTRAINT NB_MABT_FK FOREIGN KEY(MABT)
	REFERENCES BAITAP(MABT)

SET DATEFORMAT DMY

INSERT INTO BAITAP VALUES('BT1', 2, 'Binary tree')
INSERT INTO BAITAP VALUES('BT2', 1, 'Linked list')
INSERT INTO BAITAP VALUES('BT3', 3, 'Hash')

INSERT INTO DOKHO VALUES(1, 20)
INSERT INTO DOKHO VALUES(2, 40)
INSERT INTO DOKHO VALUES(3, 60)

INSERT INTO NOPBAI VALUES('BN1','TV2','BT2','20/10/2018',30)
INSERT INTO NOPBAI VALUES('BN2','TV1','BT3','20/10/2018',0)
INSERT INTO NOPBAI VALUES('BN3','TV3','BT1','21/10/2018',20)
INSERT INTO NOPBAI VALUES('BN4','TV3','BT2','21/10/2018',20)
INSERT INTO NOPBAI VALUES('BN5','TV3','BT3','21/10/2018',20)

INSERT INTO THANHVIEN VALUES('TV1', 'Ngo The Phuong', 70, 'Member', '28/12/2017')
INSERT INTO THANHVIEN VALUES('TV2', 'Ho Man Dat', 35, 'Moderator', '11/11/2017')
INSERT INTO THANHVIEN VALUES('TV3', 'Nguyen Tien Lam', 60, 'Member', '25/10/2017')

/*3 Hiện thực ràng buộc toàn vẹn sau: thành viên loại ‘Moderator’ phải có thứ hạng từ 40 trở
lên*/
GO
CREATE TRIGGER TRG_THANHVIEN_THUHANG_LOAITV_UPD_INS ON THANHVIEN
FOR UPDATE, INSERT
AS
BEGIN
	DECLARE @LOAITV VARCHAR(15),
			@THUHANG INT,
			@MATV CHAR(3)

	SELECT @LOAITV = LOAITV, @THUHANG = THUHANG, @MATV = MATV
	FROM INSERTED

	IF(@LOAITV = 'Moderator' AND @THUHANG < 40)
	BEGIN
		PRINT('LOI: THANH VIEN LOAI MODERATOR PHAI CO THU HANG TU 40 TRO LEN')
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
INSERT INTO THANHVIEN VALUES('TV4','Nguyen Van A',30,'Moderator', '1/10/2017') 

/*4 Hiện thực ràng buộc toàn vẹn sau: điểm từ hệ thống chấm không được lớn hơn điểm tối đa
của bài tập*/
GO
CREATE TRIGGER TRG_NOPBAI_DIEMHT_MABT_INS_UPD ON NOPBAI
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @DIEMHT INT,
			@MABT CHAR(3),
			@DIEMDK INT

	SELECT @DIEMHT = DIEMHT, @MABT = MABT
	FROM INSERTED

	SELECT @DIEMDK = DIEMDK
	FROM BAITAP BT JOIN DOKHO DK ON BT.MADK = DK.MADK
	WHERE MABT = @MABT

	IF(@DIEMHT > @DIEMDK)
	BEGIN 
		PRINT('TRG_NOPBAI_DIEMHT_MABT_INS_UPD: DIEM HE THONG KHONG DUOC LON HOC DIEM TOI DA CUA BT')
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
UPDATE NOPBAI
SET DIEMHT = 31 --Error
WHERE MABN = 'BN1'

/*GO --Còn 1 trigger chưa viết xong
CREATE TRIGGER TRG_BAITAP_MADK_UPD ON BAITAP
FOR UPDATE
AS*/

GO
CREATE TRIGGER TRG_DOKHO_DIEMDK_UPD ON DOKHO
FOR UPDATE
AS
BEGIN
	IF EXISTS(	SELECT*
				FROM (INSERTED DK JOIN BAITAP BT ON DK.MADK = BT.MADK)
						JOIN NOPBAI NB ON NB.MABT = BT.MABT
				WHERE DIEMHT > DIEMDK)
	BEGIN
		PRINT('TRG_DOKHO_DIEMDK_UPD: DIEM HE THONG KHONG DUOC LON HOC DIEM TOI DA CUA BT')
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
UPDATE DOKHO
SET DIEMDK = 10 
WHERE MADK = 1

/*5 Tìm tất cả thành viên (MATV, TEN) giải được bài tập có độ khó mức 2, sắp xếp kết quả tăng
dần theo tên thành viên*/
SELECT TV.MATV, TENTV
FROM (BAITAP BT JOIN NOPBAI NB ON BT.MABT = NB.MABT)
		JOIN THANHVIEN TV ON TV.MATV = NB.MATV
WHERE MADK = 2
ORDER BY TENTV ASC

/*6 Tìm tất cả thành viên (MATV, TEN) không giải bài tập nào trong năm 2017*/
SELECT MATV, TENTV
FROM THANHVIEN
EXCEPT
SELECT NB.MATV, TENTV
FROM NOPBAI NB JOIN THANHVIEN TV ON NB.MATV = TV.MATV
WHERE YEAR(NGAYNOP) = 2017

/*7 Tìm tất cả thành viên (MATV, TEN) có tổng điểm cao thứ 2 trong tháng 10/2018*/
SELECT TOP 2 WITH TIES TV.MATV, TENTV
FROM NOPBAI NB JOIN THANHVIEN TV ON NB.MATV = TV.MATV
WHERE MONTH(NGAYNOP) = 10 AND YEAR(NGAYNOP) = 2018
GROUP BY TV.MATV, TENTV
ORDER BY SUM(DIEMHT) DESC

/*8 Tìm tất cả thành viên (MATV, TEN) giải được bài tập ở tất cả các mức độ khó*/
SELECT MATV, TENTV
FROM THANHVIEN TV
WHERE NOT EXISTS(	SELECT*
					FROM DOKHO DK
					WHERE NOT EXISTS(	SELECT*
										FROM NOPBAI NB JOIN BAITAP BT ON NB.MABT = BT.MABT
										WHERE BT.MADK = DK.MADK
										AND TV.MATV = NB.MATV))
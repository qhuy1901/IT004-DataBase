CREATE DATABASE DE6_QuanLyThueXe 
USE DE6_QuanLyThueXe

CREATE TABLE XE
(
	MAXE CHAR(3) CONSTRAINT XE_MAXE_PK PRIMARY KEY,
	MALOAI CHAR(3), 
	GIANGAY MONEY,
	TINHTRANG VARCHAR(25),
	NGBD SMALLDATETIME
)

CREATE TABLE LOAIXE
(
	MALOAI CHAR(3) CONSTRAINT LX_MALOAI_PK PRIMARY KEY,
	TENXE VARCHAR(25) NOT NULL,
	SOCHO INT
)

CREATE TABLE KHACHHANG
(
	MAKH CHAR(3) CONSTRAINT KH_MAKH_PK PRIMARY KEY,
	TENKH VARCHAR(25) NOT NULL,
	TUOI INT,
	GIOITINH VARCHAR(25),
	CMND INT
)

CREATE TABLE THUEXE
(
	MAHD CHAR(3) CONSTRAINT TX_MAHD_PK PRIMARY KEY,
	MAXE CHAR(3),
	MAKH CHAR(3),
	NGTHUE SMALLDATETIME,
	NGTRA SMALLDATETIME
)

ALTER TABLE XE ADD CONSTRAINT XE_MALOAI_FK FOREIGN KEY(MALOAI)
	REFERENCES LOAIXE(MALOAI)

ALTER TABLE THUEXE ADD CONSTRAINT TX_MAXE_FK FOREIGN KEY(MAXE)
	REFERENCES XE(MAXE)

ALTER TABLE THUEXE ADD CONSTRAINT TX_MAKH_FK FOREIGN KEY(MAKH)
	REFERENCES KHACHHANG(MAKH)

SET DATEFORMAT DMY
INSERT INTO LOAIXE VALUES('L1','Ford Transit',16)
INSERT INTO LOAIXE VALUES('L2','Samco',29)
INSERT INTO LOAIXE VALUES('L3','Innova',7)

INSERT INTO KHACHHANG VALUES('KH1','Tran Thanh Phong',24,'Nam',165185624)
INSERT INTO KHACHHANG VALUES('KH2','Pham The Manh',26,'Nam',167356984)
INSERT INTO KHACHHANG VALUES('KH3','Nguyen Minh Nghia',30,'Nam',180952346)

INSERT INTO XE VALUES('XE1','L3',800000,'Su dung tot','28/12/2017')
INSERT INTO XE VALUES('XE2','L2',2500000,'Su dung tot','28/11/2017')
INSERT INTO XE VALUES('XE3','L3',850000,'Dang sua chua','25/05/2015')

INSERT INTO THUEXE VALUES('HD1', 'XE2','KH3','20/06/2018','22/06/2018')
INSERT INTO THUEXE VALUES('HD2', 'XE3','KH2','20/07/2018','23/07/2018')
INSERT INTO THUEXE VALUES('HD3', 'XE1','KH1','15/10/2018','17/10/2018')
INSERT INTO THUEXE VALUES('HD4', 'XE2','KH1','16/10/2018','17/10/2018')
INSERT INTO THUEXE VALUES('HD5', 'XE3','KH1','17/10/2018','17/10/2018')

/*3. Hiện thực ràng buộc toàn vẹn sau: ngày trả xe phải sau ngày thuê xe*/
GO
CREATE TRIGGER TRG_TX_NGTHUE_NGTRA_UPD ON THUEXE
FOR UPDATE, INSERT
AS
BEGIN
	DECLARE @NGTHUE SMALLDATETIME,
			@NGTRA SMALLDATETIME,
			@MAHD CHAR(3)

	SELECT @NGTHUE = NGTHUE, @NGTRA = NGTRA
	FROM INSERTED

	IF(@NGTHUE > @NGTRA)
	BEGIN
		RAISERROR('LOI: NGAY TRA XE PHAI SAU NGAY TRA XE',16,1)
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
INSERT INTO THUEXE VALUES('HD9','XE1','KH1','15/10/2018','10/10/2018') 

/*4. Hiện thực ràng buộc toàn vẹn sau: ngày khách hàng thuê xe phải sau ngày bắt đầu cho thuê
của xe đó.*/
GO
CREATE TRIGGER TRG_TX_NGTHUE_MAXE_UPD_INS ON THUEXE
FOR UPDATE, INSERT
AS
BEGIN
	DECLARE @NGTHUE SMALLDATETIME,
			@NGBD SMALLDATETIME,
			@MAXE CHAR(3)

	SELECT @NGTHUE = NGTHUE, @MAXE = MAXE
	FROM INSERTED

	SELECT @NGBD = NGBD
	FROM XE
	WHERE @MAXE = MAXE

	IF(@NGTHUE < @NGBD)
	BEGIN
		PRINT('TRG_TX_NGTHUE_MAXE_UPD_INS: NGAY KHACH HANG THUE XE PHAI SAU NGAY BAT DAU CHO THUE CUA XE DO')
		ROLLBACK TRANSACTION
	END
END
--Kiểm tra Trigger
INSERT INTO THUEXE VALUES('HD9','XE1','KH1','10/10/2007','10/10/2018') 

/*Cách 1*/
GO
CREATE TRIGGER TRG_XE_NGBD_UPD ON XE
FOR UPDATE
AS
BEGIN
	IF EXISTS(	SELECT*
				FROM INSERTED XE JOIN THUEXE TX ON XE.MAXE = TX.MAXE
				WHERE NGBD > NGTHUE)
	BEGIN 
		RAISERROR('TRG_XE_NGBD_UPD: NGAY KHACH HANG THUE XE PHAI SAU NGAY BAT DAU CHO THUE CUA XE DO',16,1)
		ROLLBACK TRANSACTION
	END
END

/*Cách 2*/
GO
CREATE TRIGGER TRG_XE_NGBD_UPD ON XE
FOR UPDATE
AS
BEGIN
	DECLARE @NGTHUE SMALLDATETIME,
			@NGBD SMALLDATETIME,
			@MAXE CHAR(3)

	SELECT @NGBD = NGBD, @MAXE = MAXE
	FROM INSERTED

	DECLARE cur_THUEXE CURSOR 
	FOR
		SELECT MAXE
		FROM THUEXE
		WHERE MAXE = @MAXE

	OPEN cur_THUEXE
	FETCH NEXT FROM cur_THUEXE
	INTO @MAXE

	WHILE @@FETCH_STATUS = 0
	BEGIN
		SELECT @NGTHUE = NGTHUE
		FROM THUEXE
		WHERE MAXE = @MAXE

		IF(@NGTHUE < @NGBD)
		BEGIN 
			PRINT('TRG_XE_NGBD_UPD: NGAY KHACH HANG THUE XE PHAI SAU NGAY BAT DAU CHO THUE CUA XE DO')
			ROLLBACK TRANSACTION
		END
		ELSE
		BEGIN
			FETCH NEXT FROM cur_THUEXE INTO @MAXE
		END
	END
	CLOSE cur_THUEXE
	DEALLOCATE cur_THUEXE
END
--Kiểm tra Trigger
UPDATE XE
SET NGBD = '28/12/2020' 
WHERE MAXE = 'XE1'

/*5. Tìm tất cả các khách hàng đã từng thuê xe ‘Innova’ năm 2017, sắp xếp kết quả tăng dần theo
tên khách hàng*/
SELECT KH.MAKH, TENKH
FROM ((KHACHHANG KH JOIN THUEXE TX ON KH.MAKH = TX.MAKH)
		JOIN XE ON XE.MAXE = TX.MAXE)
			JOIN LOAIXE LX ON LX.MALOAI = XE.MALOAI
WHERE TENXE = 'Innova'AND YEAR(NGTHUE) = 2017
ORDER BY TENKH ASC

/*6. Tìm xe ít được thuê nhất năm 2018*/
SELECT TOP 1 WITH TIES XE.MAXE, COUNT(*) SOLANDUOCTHUE
FROM XE JOIN THUEXE TX ON XE.MAXE = TX.MAXE
WHERE YEAR(NGTHUE) = 2018
GROUP BY XE.MAXE
ORDER BY COUNT(*) ASC

/*7. Một nhóm khách hàng có 6 người đang cần thuê 01 xe để đi du lịch vào ngày 20-12-2018,
hãy gợi ý tất cả các xe có thể phục vụ cho nhóm khách*/
--Cách 1
SELECT MAXE, LX.MALOAI, TENXE
FROM XE JOIN LOAIXE LX ON XE.MALOAI = LX.MALOAI
WHERE SOCHO >= 6 AND MAXE NOT IN(	SELECT MAXE	
									FROM THUEXE
									WHERE NGTHUE = '20/12/2018')

--Cách 2
SELECT MAXE, LX.MALOAI, TENXE
FROM XE JOIN LOAIXE LX ON XE.MALOAI = LX.MALOAI
WHERE SOCHO >= 6
EXCEPT
SELECT TX.MAXE, LX.MALOAI, TENXE
FROM (XE JOIN LOAIXE LX ON XE.MALOAI = LX.MALOAI)
		JOIN THUEXE TX ON TX.MAXE = XE.MAXE
WHERE SOCHO >= 6 AND NGTHUE = '20/12/2018'

/*8. Tìm hành khách đã từng thuê tất cả các loại xe*/
SELECT KH.MAKH, TENKH
FROM KHACHHANG KH
WHERE NOT EXISTS(	SELECT*
					FROM XE
					WHERE NOT EXISTS(	SELECT*
										FROM THUEXE TX
										WHERE TX.MAKH = KH.MAKH
										AND XE.MAXE = TX.MAXE))